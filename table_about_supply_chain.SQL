/*
说明：选择一张订单，查看其处理流程，从而了解供应链业务流程
作者：王政鸣
更新时间：2017-6-22
SQL脚本类型：impala
*/

-- 选择订单
SELECT * FROM JOLLY.WHO_ORDER_INFO
WHERE ADD_TIME >= CAST(CAST('2017-06-08 12:00:00' AS TIMESTAMP) AS INT)
        AND ADD_TIME <= CAST(CAST('2017-06-08 12:10:00' AS TIMESTAMP) AS INT)
        AND ORDER_STATUS = 1
        AND PAY_STATUS = 1
        AND SHIPPING_STATUS = 1
LIMIT 10;
-- ORDER_ID = 10264765, ORDER_SN = 'ARA17021901440942813241';

-- 查看订单信息WHO_ORDER_INFO
-- 或者使用ZYDB.DW_ORDER_SUB_ORDER_FACT
-- 两表部分字段的数据类型有差别，特别是日期类型
SELECT * FROM JOLLY.WHO_ORDER_INFO
WHERE ORDER_ID = 10264765;
-- 可以看到订单的添加、支付、审核、打包、发运等时间，其他一些时间则不在订单信息表中
WITH T AS
(SELECT ORDER_SN
       ,ORDER_ID
       ,CAST(ADD_TIME AS TIMESTAMP) AS ADD_TIME     -- 添加时间
       ,CAST((CASE WHEN PREPARE_PAY_TIME = 0 THEN PAY_TIME ELSE PREPARE_PAY_TIME END) AS TIMESTAMP) AS PAY_TIME     -- 支付时间
       ,CAST(NO_PROBLEMS_ORDER_UPTIME AS TIMESTAMP) AS NO_PROBLEMS_ORDER_UPTIME     --审核时间
       ,CAST(ORDER_PACK_TIME AS TIMESTAMP) AS ORDER_PACK_TIME      -- 打包时间
       ,CAST(SHIPPING_TIME AS TIMESTAMP) AS SHIPPING_TIME      -- 发货时间
FROM JOLLY.WHO_ORDER_INFO
WHERE ORDER_ID = 10264765
)
SELECT * FROM T;
-- 供应链流程中其他操作的时间需要单独取得
-- 计算该订单发货时长
SELECT ORDER_SN
        ,PAY_TIME
        ,SHIPPING_TIME
        -- 计算从PAY到SHIP的时间：发货时长：95.595H
        ,(UNIX_TIMESTAMP(SHIPPING_TIME) - UNIX_TIMESTAMP(PAY_TIME))/60/60 AS SHIPPING_TOTAL_TIME
FROM T;


-- 查看订单商品明细JOLLY.WHO_ORDER_GOODS
-- 关联关系：WHO_ORDER_INFO.ORDER_ID = WHO_ORDER_GOODS.ORDER_ID
-- 商品数量：12，SKU_ID：12个，GOODS_ID：12
SELECT * FROM JOLLY.WHO_ORDER_GOODS
WHERE ORDER_ID = 10264765
ORDER BY GOODS_ID;
-- GOODS_ID：商品ID，GOODS_SN：商品编码，SKU_ID：SKUID，REC_ID：主键

-- 这个订单中有没有商品需要采购？
-- 订单采购商品审核锁定明细表WHO_WMS_GOODS_NEED_LOCK_DETAIL
SELECT * FROM JOLLY.WHO_WMS_GOODS_NEED_LOCK_DETAIL
WHERE ORDER_ID = 10264765;
-- 12个商品中：3个已有库存，6个需要采购，3个需要调拨，商品件数为9（num）
-- SOURCE_TYPE = 1：采购；SOURCE_TYPE = 2：调拨；

-- 关联WHO_ORDER_GOODS和WHO_WMS_GOODS_NEED_LOCK_DETAIL
-- WHO_ORDER_GOODS.REC_ID = WHO_WMS_GOODS_NEED_LOCK_DETAIL.ORDER_GOODS_REC_ID
-- WHO_ORDER_GOODS.ORDER_ID = WHO_WMS_GOODS_NEED_LOCK_DETAIL.ORDER_ID  -- 一般用这个关联关系
SELECT A.REC_ID  -- 商品主键
        ,A.ORDER_ID
        ,A.GOODS_ID
        ,A.SKU_ID
        ,A.GOODS_SN
        ,A.GOODS_NUMBER
        ,B.DEPOT_ID
        ,B.SKU_ID
        ,B.ORDER_GOODS_REC_ID
        ,B.SOURCE_REC_ID
        ,B.NUM
        ,B.SOURCE_TYPE
FROM JOLLY.WHO_ORDER_GOODS A
LEFT JOIN JOLLY.WHO_WMS_GOODS_NEED_LOCK_DETAIL B ON A.REC_ID = B.ORDER_GOODS_REC_ID
WHERE A.ORDER_ID = 10264765;

-- 采购需求表WHO_WMS_PUR_GOODS_DEMAND
SELECT * FROM JOLLY.WHO_WMS_PUR_GOODS_DEMAND
WHERE ORDER_ID =10264765;
-- 都是采购的，调拨的不在此表中
-- 发现一个奇怪的事情，ORDER_ID = 16603573的订单，采购需求表中部分商品的PUR_TYPE是供应商备货，不应该是1订单需要吗？
-- 这几个SOURCE_REC_ID:143945077,143945079,143945085,143945087；

-- 关联WHO_ORDER_GOODS和WHO_WMS_PUR_GOODS_DEMAND
-- WHO_ORDER_GOODS.REC_ID = WHO_WMS_PUR_GOODS_DEMAND.SOURCE_REC_ID
SELECT A.REC_ID
        ,A.ORDER_ID
        ,A.GOODS_ID
        ,A.SKU_ID
        ,A.GOODS_SN
        ,A.GOODS_NUMBER
        ,B.DEPOT_ID
        ,B.SKU_ID
        ,B.SOURCE_REC_ID
        ,B.PUR_ORDER_GOODS_ID
        ,B.IN_PRICE
        ,B.SUPP_NUM
        ,B.PUR_TYPE
        ,FROM_UNIXTIME(B.GMT_CREATED) AS GMT_CREATED
        ,FROM_UNIXTIME(B.CHECK_TIME) AS CHECK_TIME
FROM JOLLY.WHO_ORDER_GOODS A
LEFT JOIN JOLLY.WHO_WMS_PUR_GOODS_DEMAND B ON A.REC_ID = B.SOURCE_REC_ID
WHERE A.ORDER_ID = 10264765;

-- 关联WHO_WMS_GOODS_NEED_LOCK_DETAIL和WHO_WMS_PUR_GOODS_DEMAND
-- WHO_WMS_GOODS_NEED_LOCK_DETAIL.ORDER_GOODS_REC_ID = WHO_WMS_PUR_GOODS_DEMAND.SOURCE_REC_ID
-- WHO_WMS_GOODS_NEED_LOCK_DETAIL.SOURCE_REC_ID = WHO_WMS_PUR_GOODS_DEMAND.REC_ID
SELECT A.REC_ID
        ,A.ORDER_ID
        ,A.ORDER_GOODS_REC_ID
        ,A.SKU_ID
        ,A.CHECK_TIME
        ,A.NUM
        ,A.OOS_NUM
        ,A.ORG_NUM
        ,A.SOURCE_REC_ID
        ,A.SOURCE_TYPE
        ,A.DEPOT_ID
        ,B.REC_ID
        ,B.GOODS_ID
        ,B.GOODS_SN
        ,B.SKU_ID
        ,B.SOURCE_REC_ID
        ,B.PROVIDER_CODE
        ,B.SUPP_NAME
        ,B.IN_PRICE
        ,B.SUPP_NUM
        ,B.PUR_TYPE
        ,B.REVIEW_STATUS
        ,B.SEND_NUM
        ,B.OOS_NUM
        ,FROM_UNIXTIME(B.GMT_CREATED) AS GMT_CREATED
        ,FROM_UNIXTIME(B.CHECK_TIME) AS CHECK_TIME
FROM JOLLY.WHO_WMS_GOODS_NEED_LOCK_DETAIL A
LEFT JOIN JOLLY.WHO_WMS_PUR_GOODS_DEMAND B ON A.ORDER_GOODS_REC_ID = B.SOURCE_REC_ID
WHERE A.ORDER_ID = 10264765;

-- 把线上线下采购需求合并一起
-- 线上采购（门户供应商）：采购需求表goods_demand中的check_time就是采购推送时间；
-- 线下采购：生成线下采购单（需关联采购单表）的时间记为采购需求的推送时间；
WITH T AS
(SELECT P1.REC_ID
        ,P1.REVIEW_STATUS
        ,P1.PUR_ORDER_GOODS_ID
        ,P1.CHECK_TIME AS GMT_CREATED    --推送时间
        ,P2.DEMAND_REC_ID
        ,P1.SOURCE_REC_ID  -- 商品主键
        ,(CASE WHEN P1.PUR_ORDER_GOODS_ID IS NULL
                        THEN P2.DEMAND_REC_ID
                        ELSE P1.PUR_ORDER_GOODS_ID
          END) AS PUR_ORDER_GOODS_REC_ID
FROM JOLLY.WHO_WMS_PUR_GOODS_DEMAND P1
LEFT JOIN JOLLY.WHO_WMS_DEMAND_GOODS_RELATION P2 ON P1.REC_ID = P2.PUR_ORDER_GOODS_REC_ID
WHERE P1.ORDER_ID = 10264765
)
SELECT * FROM T;
-- 发现：6件需采购的商品中，1件线下采购，5件线上采购
-- REVIEW_STATUS = 0/1：线上采购；= 2：线下采购；


-- 采购单 WHO_WMS_PUR_ORDER_INFO
SELECT *
FROM JOLLY.WHO_WMS_PUR_ORDER_INFO
LIMIT 10;

-- 采购商品明细 WHO_WMS_PUR_ORDER_GOODS
SELECT *
FROM JOLLY.WHO_WMS_PUR_ORDER_GOODS
LIMIT 10;

-- 与线上线下采购需求合并表关联，得到每个商品各节点的信息
WITH T AS
(SELECT P1.REC_ID
        ,P1.REVIEW_STATUS
        ,P1.PUR_ORDER_GOODS_ID
        ,P1.CHECK_TIME AS GMT_CREATED    --推送时间
        ,P2.DEMAND_REC_ID
        ,P1.SOURCE_REC_ID  -- 商品主键
        ,(CASE WHEN P1.PUR_ORDER_GOODS_ID IS NULL
                        THEN P2.DEMAND_REC_ID
                        ELSE P1.PUR_ORDER_GOODS_ID
          END) AS PUR_ORDER_GOODS_REC_ID
FROM JOLLY.WHO_WMS_PUR_GOODS_DEMAND P1
LEFT JOIN JOLLY.WHO_WMS_DEMAND_GOODS_RELATION P2 ON P1.REC_ID = P2.PUR_ORDER_GOODS_REC_ID
),
T4 AS
(SELECT ORDER_SN
       ,ORDER_ID
       ,CAST(ADD_TIME AS TIMESTAMP) AS ADD_TIME     -- 添加时间
       ,CAST((CASE WHEN PREPARE_PAY_TIME = 0 THEN PAY_TIME ELSE PREPARE_PAY_TIME END) AS TIMESTAMP) AS PAY_TIME     -- 支付时间
       ,CAST(NO_PROBLEMS_ORDER_UPTIME AS TIMESTAMP) AS NO_PROBLEMS_ORDER_UPTIME     --审核时间
       ,CAST(ORDER_PACK_TIME AS TIMESTAMP) AS ORDER_PACK_TIME      -- 打包时间
       ,CAST(SHIPPING_TIME AS TIMESTAMP) AS SHIPPING_TIME      -- 发货时间
FROM JOLLY.WHO_ORDER_INFO
)
-- 明细数据
SELECT T1.ORDER_ID
        ,T1.GOODS_ID
        ,T1.REC_ID
        ,T1.SKU_ID
        ,T.PUR_ORDER_GOODS_REC_ID
        ,T1.ORIGINAL_GOODS_NUMBER
        ,T3.PUR_ORDER_ID
        ,T3.PUR_ORDER_SN
        ,T3.CREATE_TYPE
        ,T3.TYPE
        ,T3.DEPOT_ID
        ,T.REVIEW_STATUS
        ,T4.ADD_TIME    -- 添加时间
        ,T4.PAY_TIME    -- 支付时间
        ,(CASE WHEN T.REVIEW_STATUS = 2 THEN CAST(T3.GMT_CREATED AS TIMESTAMP)
                         ELSE CAST(T.GMT_CREATED AS TIMESTAMP)
          END) AS PUSH_TIME    -- 采购推送时间
        ,T4.NO_PROBLEMS_ORDER_UPTIME    -- 订单标非时间
        ,CAST(T3.GMT_CREATED AS TIMESTAMP) AS PUR_ORDER_CREATED_TIME    -- 采购单生成时间
        ,FROM_UNIXTIME(T5.GMT_CREATED) AS RECEIPT_TIME      -- 采购到货签收时间
        ,T4.ORDER_PACK_TIME    -- 打包时间
        ,T4.SHIPPING_TIME    -- 发货时间
FROM JOLLY.WHO_ORDER_GOODS T1
LEFT JOIN T4 ON T1.ORDER_ID = T4.ORDER_ID
LEFT JOIN T ON T1.REC_ID = T.SOURCE_REC_ID
LEFT JOIN JOLLY.WHO_WMS_PUR_ORDER_GOODS T2 ON T.PUR_ORDER_GOODS_REC_ID = T2.REC_ID
LEFT JOIN JOLLY.WHO_WMS_PUR_ORDER_INFO T3 ON T2.PUR_ORDER_ID = T3.PUR_ORDER_ID
LEFT JOIN ZYDB.ODS_WMS_PUR_DELIVER_RECEIPT T5 ON T3.PUR_ORDER_SN = T5.PUR_ORDER_SN
WHERE T1.ORDER_ID = 10264765;
-- 发现：由于需要采购的6个商品来自6个不同的供应商，则这6个商品分别在6张采购单中；


-- 到货签收表
-- JOLLY.WHO_WMS_PUR_DELIVER_RECEIPT（物流单号与采购单号仍是一对多的关系）
-- ZYDB.ODS_WMS_PUR_DELIVER_RECEIPT（物流单号与采购单号是一对一的关系）
-- 到货签收商品明细表 JOLLY.WHO_WMS_PUR_DELIVER_GOODS

SELECT * FROM ZYDB.ODS_WMS_PUR_DELIVER_RECEIPT LIMIT 10;

SELECT * FROM JOLLY.WHO_WMS_PUR_DELIVER_GOODS LIMIT 10;



-- 到货单表
-- jolly.ho_wms_delivered_order_info
SELECT *
FROM jolly.who_wms_delivered_order_info
LIMIT 10;

-- 签收表
-- jolly.who_wms_delivered_receipt_info











-- 需采购和无需采购的订单，在发货时长上有明显差异吗？

-- 获取订单的支付-打包-发货时间
WITH T1 AS
(SELECT ORDER_ID
       ,CAST(ADD_TIME AS TIMESTAMP) AS ADD_TIME     -- 添加时间
       ,CAST((CASE WHEN PREPARE_PAY_TIME = 0 THEN PAY_TIME ELSE PREPARE_PAY_TIME END) AS TIMESTAMP) AS PAY_TIME     -- 支付时间
       ,CAST(NO_PROBLEMS_ORDER_UPTIME AS TIMESTAMP) AS NO_PROBLEMS_ORDER_UPTIME     --审核时间
       ,CAST(ORDER_PACK_TIME AS TIMESTAMP) AS ORDER_PACK_TIME      -- 打包时间
       ,CAST(SHIPPING_TIME AS TIMESTAMP) AS SHIPPING_TIME      -- 发货时间
FROM JOLLY.WHO_ORDER_INFO
WHERE SHIPPING_TIME >= CAST(CAST('2017-06-08 00:00:00' AS TIMESTAMP) AS INT)
      AND SHIPPING_TIME <= CAST(CAST('2017-06-09 00:00:00' AS TIMESTAMP) AS INT)
),

-- 计算时长
T2 AS
(
SELECT ORDER_ID
        ,(CAST(T1.SHIPPING_TIME AS INT) - CAST(T1.PAY_TIME AS INT))/3600 AS PAY_SHIPPING_DURATION
        ,(CAST(T1.ORDER_PACK_TIME AS INT) - CAST(T1.PAY_TIME AS INT))/3600 AS PAY_PACK_DURATION
        ,(CAST(T1.SHIPPING_TIME AS INT) - CAST(T1.ORDER_PACK_TIME AS INT))/3600 AS PACK_SHIPPING_DURATION
FROM T1
-- ORDER BY PAY_SHIPPING_DURATION DESC
-- LIMIT 100
),

-- 查询近期所有有采购需求的订单ID
T3 AS
(
SELECT ORDER_ID
FROM JOLLY.WHO_WMS_GOODS_NEED_LOCK_DETAIL
WHERE CHECK_TIME >= CAST(CAST('2017-05-20 00:00:00' AS TIMESTAMP) AS INT)
      AND CHECK_TIME <= CAST(CAST('2017-06-09 00:00:00' AS TIMESTAMP) AS INT)
GROUP BY ORDER_ID
)

SELECT COUNT(ORDER_ID) AS ORDER_NUM
        ,AVG(PAY_SHIPPING_DURATION)
        ,AVG(PAY_PACK_DURATION)
        ,AVG(PACK_SHIPPING_DURATION)
FROM T2
WHERE ORDER_ID NOT IN
(SELECT ORDER_ID FROM T3)






SELECT COUNT(ORDER_ID) AS ORDER_NUM









